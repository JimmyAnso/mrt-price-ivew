<template>
  <div class="home">
    <!-- Logo -->
    <div class="home__logo">
      <h2 class="home__title">台北捷運票價</h2>
      <span>X</span>
      <a href="https://www.metro.taipei/" target="_blank">
        <img src="../../public/image/metro_taipei_logo.png" alt=""
      /></a>
    </div>
    <Divider />
    <!-- 起點 -->
    <Row type="flex" justify="space-between" class="code-row-bg selector">
      <Col span="7" offset="1">
        <p>{{ start.title }}：</p>
      </Col>

      <Col span="7" offset="1">
        <Select v-model="input.startLineID" @input="getStartStationData">
          <Option v-for="item in lineData" :key="item" :value="item.LineID"
            >{{ item.LineID }}{{ item.LineName.Zh_tw }}</Option
          >
        </Select>
      </Col>

      <Col span="7" offset="1">
        <Select v-model="input.startStationID" @input="startStationChange">
          <Option
            v-for="item in startStationData.Stations"
            :key="item"
            :value="item.StationID"
            >{{ item.StationName.Zh_tw }}</Option
          >
        </Select>
      </Col>
    </Row>
    <!-- 終點 -->
    <Row type="flex" justify="space-between" class="code-row-bg selector">
      <Col span="7" offset="1">
        <p>{{ end.title }}：</p>
      </Col>

      <Col span="7" offset="1">
        <Select v-model="input.endLineID" @input="getEndStationData">
          <Option v-for="item in lineData" :key="item" :value="item.LineID"
            >{{ item.LineID }}{{ item.LineName.Zh_tw }}</Option
          >
        </Select>
      </Col>

      <Col span="7" offset="1">
        <Select v-model="input.endStationID" @input="endStationChange">
          <Option
            v-for="item in endStationData.Stations"
            :key="item"
            :value="item.StationID"
            >{{ item.StationName.Zh_tw }}</Option
          >
        </Select>
      </Col>
    </Row>

    <!-- 按鈕 -->
    <div class="home__button">
      <ButtonGroup size="large" shape="circle">
        <Button @click="resetAll" type="primary" icon="md-refresh">重選</Button>
      </ButtonGroup>

      <ButtonGroup size="large" shape="circle">
        <Button
          id="test"
          v-bind:class="{ searchActive: searchIsActive }"
          @click="getPrice"
          type="primary"
          icon="ios-search"
          >查詢</Button
        >
      </ButtonGroup>
    </div>
  </div>
</template>

<script>
import axios from "axios";
import jsSHA from "jssha";
export default {
  data() {
    return {
      searchIsActive: false,
      input: {
        startLineID: null,
        startStationID: null,
        endLineID: null,
        endStationID: null,
      },
      start: {
        cls: "start",
        title: "起點",
      },
      end: {
        cls: "end",
        title: "終點",
      },
      apiUrl: {
        getLineDataUrl:
          "https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/Line/TRTC?$top=30&$format=JSON",
        getStationDataUrl:
          "https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/StationOfLine/TRTC?$top=30&$format=JSON",
      },
      lineData: {},
      startStationData: {},
      endStationData: {},
      priceData: {},
      priceAdult: null,
      priceSeniorDisabled: null,
      startLineName: null,
      startStationName: null,
      endLineName: null,
      endStationName: null,
    };
  },
  computed: {
    getPriceDataUrl() {
      return (
        "https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/ODFare/TRTC?$filter=OriginStationID%20eq%20'" +
        this.input.startStationID +
        "'%20and%20DestinationStationID%20eq%20'" +
        this.input.endStationID +
        "'&$format=JSON"
      );
    },
    searchIsActive() {
      if (
        this.input.startStationID != null &&
        this.input.endStationID != null
      ) {
        return true;
      } else {
        return false;
      }
    },
  },
  beforeEnter() {
    this.input.startStationID = null;
    this.input.endStationID = null;
  },
  // beforeRouteEnter(){
  //   this.input.startStationID = null;
  //   this.input.endStationID = null;
  // },
  created() {
    this.getLineData();
    this.input.startStationID = null;
    this.input.endStationID = null;
  },
  methods: {
    warning() {
      this.$Message.warning("This is a warning tip");
    },
    error() {
      this.$Message.error("This is an error tip");
    },
    closable() {
      this.$Message.info({
        content: "Tips for manual closing",
        duration: 10,
        closable: true,
      });
    },
    getAPI(currentUrl, currentFun) {
      const options = {
        method: "GET",
        headers: this.GetAuthorizationHeader(),
        url: currentUrl,
      };
      // axios(options);
      return axios(options)
        .then((response) => {
          // handle success
          console.log(response);
          currentFun(response);
        })
        .catch(function (error) {
          // handle error
          console.log(error);

          // alert('請完成填選 "起點" 與 "目的地"');
        });
      return;
    },
    lineDataHandler(currentResponse) {
      this.lineData = currentResponse.data;
    },
    // 起點取得站Handler
    startStationDataHandler(currentResponse) {
      this.startStationData = currentResponse.data.find(
        (line) => line.LineID == this.input.startLineID
      );
    },
    // 目的地取得站Handler
    endStationDataHandler(currentResponse) {
      this.endStationData = currentResponse.data.find(
        (line) => line.LineID == this.input.endLineID
      );
    },
    // 取得票價Handler
    getPriceHandler(currentResponse) {
      this.priceData = currentResponse.data[0];
      // 取得全票與愛心票價
      this.priceAdult = this.priceData.Fares[0].Price;
      this.priceSeniorDisabled = this.priceData.Fares[1].Price;
      console.log(this.priceData);
    },
    // 取得線
    getLineData() {
      this.getAPI(this.apiUrl.getLineDataUrl, this.lineDataHandler);
    },
    // 起點取得站
    getStartStationData(lineVmodel) {
      this.input.startLineID = lineVmodel;
      console.log("this.input.startLineID:", this.input.startLineID);

      // this.lineData
      console.log("this.lineData:", this.lineData);

      this.startLineName = this.lineData.find(
        (line) => line.LineID == this.input.startLineID
      ).LineName.Zh_tw;

      // reset
      this.input.startStationID = null;

      this.getAPI(this.apiUrl.getStationDataUrl, this.startStationDataHandler);
    },
    // 目的地取得站
    getEndStationData(lineVmodel) {
      this.input.endLineID = lineVmodel;

      this.endLineName = this.lineData.find(
        (line) => line.LineID == this.input.endLineID
      ).LineName.Zh_tw;

      this.input.endStationID = null;
      this.getAPI(this.apiUrl.getStationDataUrl, this.endStationDataHandler);
    },
    startStationChange(stationVmodel) {
      this.input.startStationID = stationVmodel;

      this.startStationName = this.startStationData.Stations.find(
        (station) => station.StationID == this.input.startStationID
      ).StationName.Zh_tw;
    },
    endStationChange(stationVmodel) {
      this.input.endStationID = stationVmodel;

      this.endStationName = this.endStationData.Stations.find(
        (station) => station.StationID == this.input.endStationID
      ).StationName.Zh_tw;
    },
    // 取得票價Handler
    getPrice() {
      if (
        this.input.startStationID != null &&
        this.input.endStationID != null
      ) {
        this.getAPI(this.getPriceDataUrl, this.getPriceHandler).then(() => {
          // this.goToResult() executed
          if (this.priceAdult && this.priceSeniorDisabled) {
            this.goToResult();
          }
        });
        console.log("起點：");
        console.log(this.input.startLineID);
        console.log(this.input.startStationID);

        console.log("目的地：");
        console.log(this.input.endLineID);
        console.log(this.input.endStationID);
      } else {
        this.$Message.warning('請完成填選 "起點" 與 "目的地"');
      }
    },
    goToResult() {
      this.$router.push({
        path: "/result",
        query: {
          start:
            this.input.startLineID +
            this.startLineName +
            "・" +
            this.startStationName,
          end:
            this.input.endLineID +
            this.endLineName +
            "・" +
            this.endStationName,
          adult: this.priceAdult,
          disabled: this.priceSeniorDisabled,
        },
      });
    },
    resetAll() {
      this.input.startLineID = null;
      this.input.startStationID = null;
      this.input.endLineID = null;
      this.input.endStationID = null;
    },
    GetAuthorizationHeader() {
      var AppID = process.env.VUE_APP_AppID;
      var AppKey = process.env.VUE_APP_AppKey;

      var GMTString = new Date().toGMTString();
      var ShaObj = new jsSHA("SHA-1", "TEXT");
      ShaObj.setHMACKey(AppKey, "TEXT");
      ShaObj.update("x-date: " + GMTString);
      var HMAC = ShaObj.getHMAC("B64");
      var Authorization =
        'hmac username="' +
        AppID +
        '", algorithm="hmac-sha1", headers="x-date", signature="' +
        HMAC +
        '"';

      return { Authorization: Authorization, "X-Date": GMTString };
    },
  },
};
</script>


<style lang="css" scoped>
@import url("https://fonts.googleapis.com/css2?family=Noto+Sans&family=Noto+Sans+TC:wght@100;300;400;500;700;900&family=Noto+Serif+TC:wght@200;300;400;500;600;700;900&display=swap");
.home__logo,
.home__button {
  width: 100%;
  display: flex;
  justify-content: space-around;
  align-items: center;
  margin-bottom: 45px;
}
.home__button--reset,
.home__button--submit {
  font-size: 18px;
  border-radius: 100px;
  padding: 15px 60px;
  border: none;
}
.home__button--reset:hover,
.home__button--submit:hover {
  cursor: pointer;
  color: white;
  background-color: #0097d9;
}
.home {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
.home__title {
  font-family: "Noto Sans", sans-serif;
  font-family: "Noto Sans TC", sans-serif;
  font-family: "Noto Serif TC", serif;
}
.home__button--submit.searchActive {
  color: white;
  background-color: #007ab0;
}
.home__button--submit.searchActive:hover {
  background-color: #0097d9;
}
.selector{
  width:100%;
  margin-bottom:10%;
}
</style>
